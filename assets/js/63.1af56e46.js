(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{532:function(t,s,a){"use strict";a.r(s);var e=a(12),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"实现方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现方式"}},[t._v("#")]),t._v(" 实现方式")]),t._v(" "),a("p",[t._v("采用任务调度中心（如：xxl-job, saturn等）+ Java定时任务的方式，清理的时候可以通过动态配置要清理的表及数据范围，以实现灵活地进行历史数据地清除或者转移。")]),t._v(" "),a("h2",{attrs:{id:"历史数据清理配置参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#历史数据清理配置参数说明"}},[t._v("#")]),t._v(" 历史数据清理配置参数说明")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("参数")]),t._v(" "),a("th",[t._v("说明")]),t._v(" "),a("th",[t._v("默认值")]),t._v(" "),a("th",[t._v("备注")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("saveHistory")]),t._v(" "),a("td",[t._v("是否保存至历史表")]),t._v(" "),a("td",[t._v("否")]),t._v(" "),a("td",[t._v("设为true，会按预设的格式新建或者匹配到已存在的历史数据表，并将清理的数据转移到该历史数据表中。")])]),t._v(" "),a("tr",[a("td",[t._v("dataSource")]),t._v(" "),a("td",[t._v("数据源")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("指定待清理数据所在的数据源标识")])]),t._v(" "),a("tr",[a("td",[t._v("tableName")]),t._v(" "),a("td",[t._v("待清理数据表名")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("指定要清理那张表的数据")])]),t._v(" "),a("tr",[a("td",[t._v("fieldName")]),t._v(" "),a("td",[t._v("时间索引字段名")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("指定按照那个字段来按时间范围进行清理，该字段必须是DATETIME类型并且已经创建了索引")])]),t._v(" "),a("tr",[a("td",[t._v("keepDays")]),t._v(" "),a("td",[t._v("保留最近几天的数据")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("指定要保留几天的数据，在此之前的数据会被清理掉")])]),t._v(" "),a("tr",[a("td",[t._v("batchSize")]),t._v(" "),a("td",[t._v("批量删除记录数")]),t._v(" "),a("td",[t._v("3000")]),t._v(" "),a("td",[t._v("清理的数据量大时，通过分批的方式进行删除，每批删除的数量")])]),t._v(" "),a("tr",[a("td",[t._v("extraConditions")]),t._v(" "),a("td",[t._v("额外查询条件")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("用于限制待清理表的数据范围")])]),t._v(" "),a("tr",[a("td",[t._v("historyTablePrefix")]),t._v(" "),a("td",[t._v("历史数据表名前缀")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("指定保存历史数据的表名前缀")])]),t._v(" "),a("tr",[a("td",[t._v("historyTableDateTimePattern")]),t._v(" "),a("td",[t._v("历史数据表名日期时间格式")]),t._v(" "),a("td",[t._v("yyyyMMdd")]),t._v(" "),a("td",[t._v("指定保存历史数据表名中的日期时间格式")])]),t._v(" "),a("tr",[a("td",[t._v("historyTableSuffix")]),t._v(" "),a("td",[t._v("历史数据表名后缀")]),t._v(" "),a("td"),t._v(" "),a("td",[t._v("指定保存历史数据的表名后缀")])])])]),t._v(" "),a("p",[t._v("示例：")]),t._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("history")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("props")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("saveHistory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dataSource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" primary\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tableName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" tt_sample\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("fieldName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" created_time\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("keepDays")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("batchSize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("extraConditions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" created_by='123456'\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("historyTablePrefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" th\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("historyTableDateTimePattern")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" yyyyMMdd\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("historyTableSuffix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" bak\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br")])]),a("p",[t._v("对应的处理过程：")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("切换至 "),a("code",[t._v("primary")]),t._v(" 数据源")])]),t._v(" "),a("li",[a("p",[t._v("将清理参数转换成查找数据 sql 如下：")]),t._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 假设执行清理的日期为 2021-04-28")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" tt_sample "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" created_time "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2021-04-13 23:59:59.999999999'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("and")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("created_by"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'123456'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("order")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("by")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("asc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])])]),t._v(" "),a("li",[a("p",[t._v("当不需要保存删除的数据到历史表时，直接根据步骤2查询出来的 id 删除数据")])]),t._v(" "),a("li",[a("p",[t._v("当需要保存删除的数据到历史表时，即 saveHistroy 为 true")]),t._v(" "),a("ul",[a("li",[t._v("按配置获取相应的历史数据表名，示例的表名为 "),a("code",[t._v("th_tt_sample_20210428_bak")])]),t._v(" "),a("li",[t._v("当上述的历史数据表不存在时，按原表 "),a("code",[t._v("tt_sample")]),t._v(" 的表结构的新增该表")]),t._v(" "),a("li",[t._v("根据步骤2中查出的 id 将数据复制到 "),a("code",[t._v("th_tt_sample_20210428_bak")]),t._v(" 表中")]),t._v(" "),a("li",[t._v("根据步骤2查询出来的 id 删除数据")])])])])])}),[],!1,null,null,null);s.default=r.exports}}]);